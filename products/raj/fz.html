<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FDPâ€‘Na çº¿æ€§æµæœºåˆ¶å›¾ </title>
<style>
  :root { --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","PingFang SC","Microsoft Yahei",sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 20px 28px}
  h1{font-size:24px;margin:0 0 4px}
  .sub{color:var(--muted);font-size:13px;margin:0 0 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;margin:8px 0 12px}
  .btn-group{display:flex;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px;background:#fff}
  .btn{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid transparent;background:#fff;cursor:pointer}
  .btn:hover{background:#f6f6f6}
  .btn.active{background:#111827;color:#fff}
  .hint{color:var(--muted);font-size:12px;padding:0 6px;align-self:center}
  .card{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#fff}
  .canvas{width:100%;overflow:auto}
  .legend{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px;margin-top:8px}
  .section{border:1px solid var(--border);border-radius:16px;padding:16px;background:#fff}
  .grid2{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:8px}
  @media (min-width:768px){.grid2{grid-template-columns:repeat(2,minmax(0,1fr))}}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div>
      <h1>FDPâ€‘Na çº¿æ€§æµ</h1>
      <div class="sub">åˆ†å­ â†’ ç»†èƒ â†’ ç»„ç»‡ â†’ å™¨å®˜ Â· çº¿å®½â‰ˆæ•ˆåº”å¼ºåº¦</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div class="btn-group" id="stepGroup">
        <button class="btn active" data-step="0">æ€»è§ˆ</button>
        <button class="btn" data-step="1">åˆ†å­â†’ç»†èƒ</button>
        <button class="btn" data-step="2">ç»†èƒâ†’ç»„ç»‡</button>
        <button class="btn" data-step="3">ç»„ç»‡â†’å™¨å®˜</button>
        <button class="btn" data-step="4">å…¨æ˜¾</button>
      </div>
      <div class="btn-group">
        <button class="btn" id="autoBtn">çº¿æ€§æ’­æ”¾</button>
        <button class="btn" id="labelBtn">å›¾æ ‡+çŸ­è¯</button>
      </div>
      <div class="btn-group">
        <span class="hint">å¼ºå¼±å¯¹æ¯”</span>
        <button class="btn" data-contrast="1">ä½</button>
        <button class="btn active" data-contrast="2">ä¸­</button>
        <button class="btn" data-contrast="3">é«˜</button>
        <button class="btn" id="primaryBtn">åªçœ‹ä¸»å¹²</button>
      </div>
      <div class="btn-group">
        <button class="btn" id="organBtn">å™¨å®˜èšç„¦</button>
        <button class="btn" id="notesBtn">éšè—è¯´æ˜</button>
      </div>
    </div>
  </div>

  <div class="card canvas">
    <svg id="stage" viewBox="0 0 1120 560" style="width:100%;height:auto;display:block"></svg>
  </div>

  <div class="legend">
    <span>çº¿å®½ = æ•ˆåº”å¼ºåº¦ï¼š</span>
    <svg width="180" height="18" viewBox="0 0 180 18" aria-hidden="true">
      <line x1="10" y1="9" x2="60" y2="9" stroke="currentColor" stroke-width="2" />
      <text x="62" y="12" font-size="10">å¼±</text>
      <line x1="95" y1="9" x2="145" y2="9" stroke="currentColor" stroke-width="6" />
      <text x="147" y="12" font-size="10">å¼º</text>
    </svg>
    <span class="hint">å¯ç»„åˆï¼šå¼ºå¼±å¯¹æ¯” / åªçœ‹ä¸»å¹² / å™¨å®˜èšç„¦ / è¯´æ˜å¼€å…³ã€‚</span>
  </div>

  <!-- å›¾ä¸‹è¯´æ˜åŒº -->
  <div id="notes" style="margin-top:16px;display:block">
    <section class="section">
      <h3 style="font-size:14px;font-weight:600;margin:0">å±‚çº§è¯´æ˜</h3>
      <div class="grid2" style="margin-top:8px;font-size:12px;color:#374151">
        <div class="section" style="padding:8px;background:#FEF3C7;border-color:#FCD34D">
          <div style="font-weight:600">åˆ†å­</div>
          <ul style="margin:4px 0 0 16px;padding:0">
            <li>å¢å¼ºç³–é…µè§£ï¼ˆPFK/PKï¼‰</li>
            <li>ATPâ†‘ï¼ŒROS å‹åŠ›â†“</li>
          </ul>
        </div>
        <div class="section" style="padding:8px;background:#D1FAE5;border-color:#A7F3D0">
          <div style="font-weight:600">ç»†èƒ</div>
          <ul style="margin:4px 0 0 16px;padding:0">
            <li>ç»´æŒç¦»å­æ³µï¼›CaÂ²âº è¿‡è½½â†“</li>
            <li>è†œ/çº¿ç²’ä½“ä¿æŠ¤</li>
          </ul>
        </div>
        <div class="section" style="padding:8px;background:#E0F2FE;border-color:#BAE6FD">
          <div style="font-weight:600">ç»„ç»‡</div>
          <ul style="margin:4px 0 0 16px;padding:0">
            <li>2,3â€‘DPGâ†‘ â†’ é‡Šæ°§â†‘</li>
            <li>çº¢ç»†èƒå˜å½¢æ€§â†‘ï¼›å¾®å¾ªç¯â†‘</li>
          </ul>
        </div>
        <div class="section" style="padding:8px;background:#FFE4E6;border-color:#FECDD3">
          <div style="font-weight:600">å™¨å®˜</div>
          <ul style="margin:4px 0 0 16px;padding:0">
            <li>å¿ƒï¼šCO/EFâ†‘ï¼Œæ¢—æ­»é¢ç§¯â†“*</li>
            <li>è„‘ï¼šç¼ºè¡€ä½“ç§¯â†“ï¼ŒåŠŸèƒ½æ¢å¤â†‘</li>
          </ul>
        </div>
      </div>
      <p style="margin:6px 0 0 0;color:#6b7280;font-size:11px">* å—å‰‚é‡/æ—¶çª—/æ¨¡å‹å½±å“ã€‚</p>
    </section>

    <section class="section" style="margin-top:12px">
      <h3 style="font-size:14px;font-weight:600;margin:0">è®²è§£è„šæœ¬ï¼ˆ30 ç§’ï¼‰</h3>
      <ol style="margin:8px 0 0 16px;font-size:12px;color:#374151">
        <li>åˆ†å­ï¼šFDPâ€‘Na ä¿ƒè¿›ç³–é…µè§£ï¼ˆPFK/PKï¼‰ï¼Œæé«˜ ATPï¼Œç¼“è§£ ROSã€‚</li>
        <li>ç»†èƒï¼šATP ä¿éšœç¦»å­æ³µä¸è†œ/çº¿ç²’ä½“ç¨³æ€ï¼ŒCaÂ²âº è¿‡è½½ä¸‹é™ã€‚</li>
        <li>ç»„ç»‡ï¼šçº¢ç»†èƒ 2,3â€‘DPGâ†‘ å³ç§»æ°§è§£ç¦»æ›²çº¿ï¼Œæœ«æ¢¢é‡Šæ°§ä¸å¾®å¾ªç¯æ”¹å–„ã€‚</li>
        <li>å™¨å®˜ï¼šå¿ƒæ’é‡/å°„è¡€åˆ†æ•°æå‡ï¼Œæ¢—æ­»ä½“ç§¯é™ä½ï¼›è„‘ç¼ºè¡€æŸä¼¤å‡è½»ã€æ¢å¤æ›´å¿«ã€‚</li>
      </ol>
    </section>

    <section class="section" style="margin-top:12px">
      <h3 style="font-size:14px;font-weight:600;margin:0">åº”ç”¨è¦ç‚¹</h3>
      <ul style="margin:8px 0 0 16px;font-size:12px;color:#374151">
        <li>æ—¶çª—ï¼šå›´ç»•ç¼ºè¡€/å†çŒæ³¨è¶Šæ—©è¶Šå¥½ï¼›å›´æœ¯æœŸå¯å‚è€ƒã€‚</li>
        <li>è”åˆï¼šä¸å¸¸è§„å†çŒæ³¨/ä¿æ¸©/é•‡é™ç­‰æ ‡å‡†æ²»ç–—å¹¶è¡Œã€‚</li>
        <li>ç›‘æµ‹ï¼šå¿ƒç”µ/ä¹³é…¸/ç¥ç»è¯„åˆ†ç­‰è·Ÿè¸ªç–—æ•ˆå“åº”ã€‚</li>
      </ul>
    </section>
  </div>
</div>

<script>
(function(){
  const state = { step:0, labelsOn:true, auto:false, contrast:2, primaryOnly:false, organFocus:false, showNotes:true, hover:null };
  const W=1120,H=560; const x=c=>120+c*280, y=r=>110+r*90;
  const svg=document.getElementById('stage'); const notesBox=document.getElementById('notes');

  const nodes=[
    {id:'pfk', col:0, row:0, emoji:'ğŸ§ª', label:'PFKâ†‘'},
    {id:'pk',  col:0, row:1, emoji:'ğŸ§ª', label:'PKâ†‘'},
    {id:'glu', col:0, row:2, emoji:'ğŸ§ª', label:'ç³–å¼‚ç”Ÿâ†“'},
    {id:'ppp', col:0, row:3, emoji:'ğŸ§ª', label:'PPP/ROSâ†“'},

    {id:'atp', col:1, row:0, emoji:'âš¡',  label:'ATPâ†‘'},
    {id:'pumps',col:1,row:1,emoji:'ğŸ§«', label:'ç¦»å­æ³µâ†‘'},
    {id:'ca',  col:1, row:2, emoji:'ğŸ§«', label:'CaÂ²âºâ†“'},
    {id:'mem', col:1, row:3, emoji:'ğŸ›¡ï¸', label:'è†œ/çº¿ç²’ä½“â†‘'},

    {id:'dpg', col:2, row:0, emoji:'ğŸ©¸', label:'2,3â€‘DPGâ†‘'},
    {id:'o2',  col:2, row:1, emoji:'ğŸ©¸', label:'é‡Šæ°§â†‘'},
    {id:'micro',col:2,row:2,emoji:'ğŸ©¸',label:'å¾®å¾ªç¯â†‘'},

    {id:'heart',col:3,row:0,emoji:'ğŸ«€',label:'å¿ƒåŠŸèƒ½â†‘'},
    {id:'infarct',col:3,row:1,emoji:'ğŸ«€',label:'æ¢—æ­»é¢ç§¯â†“*'},
    {id:'brain', col:3,row:2,emoji:'ğŸ§ ',label:'è„‘ä¿æŠ¤â†‘'},
  ];

  const NOTE={
    pfk:{title:'PFKâ†‘', bullets:['æå‡ç³–é…µè§£é€šé‡','ä¸ºç¼ºè¡€ç»†èƒå¿«é€Ÿä¾›èƒ½']},
    pk:{title:'PKâ†‘', bullets:['åŠ å¿«ä¸™é…®é…¸ç”Ÿæˆ','ç»´æŒ ATP äº§ç”Ÿ']},
    glu:{title:'ç³–å¼‚ç”Ÿâ†“', bullets:['å‡å°‘åº•ç‰©ç«äº‰','èšç„¦èƒ½é‡ä¾›ç»™']},
    ppp:{title:'PPP/ROSâ†“', bullets:['å¹³è¡¡æ—è·¯ä»£è°¢','é™ä½æ°§åŒ–åº”æ¿€']},

    atp:{title:'ATPâ†‘', bullets:['æ”¯æŒ Naâº/Kâº æ³µ','ç»´æŒè†œ/ç»†èƒå™¨ç¨³æ€']},
    pumps:{title:'ç¦»å­æ³µâ†‘', bullets:['è†œç”µä½ç¨³å®š','æ°´è‚¿é£é™©ä¸‹é™']},
    ca:{title:'CaÂ²âº è¿‡è½½â†“', bullets:['é¿å… mPTP å¼€æ”¾','å‡‹äº¡/åæ­»ä¿¡å·å‡å¼±']},
    mem:{title:'è†œ/çº¿ç²’ä½“ä¿æŠ¤', bullets:['è†œç¨³å®šæ€§â†‘','ATP åˆæˆæ•ˆç‡â†‘']},

    dpg:{title:'2,3â€‘DPGâ†‘', bullets:['Hbâ€‘Oâ‚‚ è§£ç¦»æ›²çº¿å³ç§»','æœ«æ¢¢é‡Šæ°§â†‘']},
    o2:{title:'ç»„ç»‡é‡Šæ°§â†‘', bullets:['ç¼ºè¡€åŒºæ°§ä¾›æ”¹å–„','ä¹³é…¸è´Ÿè·ä¸‹é™']},
    micro:{title:'å¾®å¾ªç¯â†‘', bullets:['å˜å½¢æ€§â†‘/èšé›†â†“','å†çŒæ³¨æ›´é€šç•…']},

    heart:{title:'å¿ƒåŠŸèƒ½â†‘', bullets:['æ”¶ç¼©/èˆ’å¼ æ”¹å–„','CO/EFâ†‘ï¼ŒLVEDPâ†“']},
    infarct:{title:'æ¢—æ­»é¢ç§¯â†“*', bullets:['å†çŒæ³¨æŸä¼¤å‡è½»','* å—å‰‚é‡/æ—¶çª—/æ¨¡å‹å½±å“']},
    brain:{title:'è„‘ä¿æŠ¤â†‘', bullets:['ç¼ºè¡€ä½“ç§¯â†“','ç¥ç»è¯„åˆ†/EEG æ¢å¤â†‘']},
  };

  const links=[
    {s:'pfk',t:'atp',w:3,stage:1}, {s:'pk',t:'atp',w:2,stage:1}, {s:'glu',t:'atp',w:1,stage:1}, {s:'ppp',t:'mem',w:1,stage:1},
    {s:'atp',t:'pumps',w:2,stage:2}, {s:'atp',t:'mem',w:2,stage:2}, {s:'atp',t:'ca',w:2,stage:2}, {s:'pumps',t:'micro',w:2,stage:2}, {s:'mem',t:'micro',w:2,stage:2}, {s:'ca',t:'micro',w:1,stage:2}, {s:'atp',t:'dpg',w:1,stage:2},
    {s:'dpg',t:'o2',w:3,stage:3}, {s:'o2',t:'heart',w:2,stage:3}, {s:'micro',t:'heart',w:2,stage:3}, {s:'micro',t:'brain',w:2,stage:3}, {s:'o2',t:'brain',w:1,stage:3}, {s:'heart',t:'infarct',w:1,stage:3},
  ];

  // å·¥å…·å‡½æ•°
  function make(name,attrs){const el=document.createElementNS('http://www.w3.org/2000/svg',name); if(attrs) for(const k in attrs) el.setAttribute(k, attrs[k]); return el;}
  function pathD(a,b){const dx=(b.x-a.x)*0.5; return `M ${a.x} ${a.y} C ${a.x+dx} ${a.y}, ${b.x-dx} ${b.y}, ${b.x} ${b.y}`;}
  function toneFill(col){return ['url(#grad-amber)','url(#grad-emerald)','url(#grad-sky)','url(#grad-rose)'][col]}
  function stageOpacity(st,w){ if(state.primaryOnly && w===1) return 0.1; if(state.step===0) return 0.7; if(state.step===4) return 1.0; return (st===state.step)?1.0:0.15 }
  function strokeWidthFor(w){ const factor = (state.contrast===1)?1.2:(state.contrast===2)?1.8:2.6; const base = (state.primaryOnly && w===1)?0.8:1.0; return base + w*factor; }

  // æ¸å˜å®šä¹‰
  const defs=make('defs'); defs.innerHTML = `
    <linearGradient id="grad-amber" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fde68a"/><stop offset="100%" stop-color="#fff"/></linearGradient>
    <linearGradient id="grad-emerald" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#a7f3d0"/><stop offset="100%" stop-color="#fff"/></linearGradient>
    <linearGradient id="grad-sky" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#bae6fd"/><stop offset="100%" stop-color="#fff"/></linearGradient>
    <linearGradient id="grad-rose" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#fecdd3"/><stop offset="100%" stop-color="#fff"/></linearGradient>`;
  const svgEl=document.getElementById('stage'); svgEl.appendChild(defs);

  // ä½ç½®
  const nodePos={}; nodes.forEach(n=>nodePos[n.id]={x:x(n.col), y:y(n.row)});

  // åˆ—é¢æ¿
  ;['åˆ†å­','ç»†èƒ','ç»„ç»‡','å™¨å®˜'].forEach((c,i)=>{
    const g=make('g'); const rect=make('rect',{x:x(i)-110,y:30,width:220,height:520-80,rx:18,fill:'#fff'});
    const text=make('text',{x:x(i),y:54,'text-anchor':'middle',fill:'#6b7280','font-size':14}); text.style.fontWeight=600; text.textContent=c;
    g.append(rect,text); svgEl.appendChild(g);
  });

  // è¿çº¿
  const linkElems=[]; links.forEach(e=>{ const a=nodePos[e.s], b=nodePos[e.t]; const p=make('path',{d:pathD(a,b),fill:'none','stroke-linejoin':'round','stroke-linecap':'round',stroke:'#111827'}); svgEl.appendChild(p); linkElems.push({e,path:p}); });

  // èŠ‚ç‚¹
  const nodeElems=[]; nodes.forEach(n=>{
    const g=make('g',{transform:`translate(${nodePos[n.id].x}, ${nodePos[n.id].y})`});
    const rect=make('rect',{x:-56,y:-20,width:112,height:40,rx:20,fill:toneFill(n.col),stroke:'#d1d5db'});
    const fo=make('foreignObject',{x:-54,y:-18,width:108,height:36});
    const div=document.createElement('div'); Object.assign(div.style,{width:'100%',height:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:'4px',borderRadius:'18px',border:'1px solid #e5e7eb',background:'transparent'});
    const emoji=document.createElement('span'); emoji.textContent=n.emoji; Object.assign(emoji.style,{fontSize:'15px',lineHeight:'1'});
    const label=document.createElement('span'); label.textContent=n.label; Object.assign(label.style,{fontSize:'11px',lineHeight:'1',color:'#1f2937'});
    div.append(emoji,label); fo.appendChild(div); g.append(rect,fo); svgEl.appendChild(g);
    g.addEventListener('mouseenter',()=>{state.hover=n.id; renderToolTip();}); g.addEventListener('mouseleave',()=>{ if(state.hover===n.id){state.hover=null; renderToolTip();}});
    nodeElems.push({n,g,rect,fo,label});
  });

  // å™¨å®˜èšç„¦å¡ç‰‡
  const organGroup=make('g',{style:'display:none'}); svgEl.appendChild(organGroup);
  function buildOrganCards(){
    while(organGroup.firstChild) organGroup.removeChild(organGroup.firstChild);
    const heartP=nodePos['heart']; const brainP=nodePos['brain'];
    const hPath=make('path',{d:pathD({x:heartP.x+56,y:heartP.y},{x:W-280,y:70}),stroke:'#9ca3af','stroke-width':1.5,fill:'none'});
    const hRect=make('rect',{x:W-280,y:28,width:240,height:120,rx:12,fill:'#fff',stroke:'#e5e7eb'});
    const hTitle=make('text',{x:W-268,y:50,'font-size':13,fill:'#111827'}); hTitle.style.fontWeight=600; hTitle.textContent='ğŸ«€ å¿ƒè„ï¼ˆåŠŸèƒ½/æŸä¼¤ï¼‰';
    const hG=make('g',{transform:`translate(${W-268}, 70)`});
    ['CO/EFâ†‘','LVEDPâ†“','STâ†˜','æ¢—æ­»é¢ç§¯â†“*'].forEach((t,i)=>{ const row=make('g',{transform:`translate(0, ${i*20})`}); row.append(make('rect',{x:0,y:-12,width:130,height:18,rx:9,fill:'#fff',stroke:'#e5e7eb'})); const txt=make('text',{x:10,y:0,'font-size':12,fill:'#111827'}); txt.textContent=t; row.append(txt); hG.append(row); });

    const bPath=make('path',{d:pathD({x:brainP.x+56,y:brainP.y},{x:W-280,y:210}),stroke:'#9ca3af','stroke-width':1.5,fill:'none'});
    const bRect=make('rect',{x:W-280,y:168,width:240,height:120,rx:12,fill:'#fff',stroke:'#e5e7eb'});
    const bTitle=make('text',{x:W-268,y:190,'font-size':13,fill:'#111827'}); bTitle.style.fontWeight=600; bTitle.textContent='ğŸ§  è„‘ï¼ˆæ¢å¤/æŸä¼¤ï¼‰';
    const bG=make('g',{transform:`translate(${W-268}, 210)`});
    ['ç¼ºè¡€ä½“ç§¯â†“','EEG æ¢å¤â†‘','ç¥ç»è¯„åˆ†â†‘'].forEach((t,i)=>{ const row=make('g',{transform:`translate(0, ${i*20})`}); row.append(make('rect',{x:0,y:-12,width:150,height:18,rx:9,fill:'#fff',stroke:'#e5e7eb'})); const txt=make('text',{x:10,y:0,'font-size':12,fill:'#111827'}); txt.textContent=t; row.append(txt); bG.append(row); });

    organGroup.append(hPath,hRect,hTitle,hG,bPath,bRect,bTitle,bG);
  }

  // åº•éƒ¨æ—¶é—´çº¿
  const tl=make('g'); tl.appendChild(make('line',{x1:x(0),y1:H-36,x2:x(3),y2:H-36,stroke:'#d1d5db','stroke-width':2})); const timelineCircles=[]; ['åˆ†å­','ç»†èƒ','ç»„ç»‡','å™¨å®˜'].forEach((c,i)=>{ const circ=make('circle',{cx:x(i),cy:H-36,r:6,stroke:'#111827','stroke-width':1}); const t=make('text',{x:x(i),y:H-16,'font-size':12,fill:'#6b7280','text-anchor':'middle'}); t.textContent=c; tl.append(circ,t); timelineCircles.push(circ); }); svgEl.appendChild(tl);

  // æç¤ºæ°”æ³¡
  let tooltipEl=null; function renderToolTip(){ if(tooltipEl){ try{svgEl.removeChild(tooltipEl);}catch(e){} tooltipEl=null; } const id=state.hover; if(!id) return; const p=nodePos[id]; const top=Math.max(30,p.y-54), left=p.x+16; tooltipEl=make('foreignObject',{x:left,y:top,width:240,height:110}); const div=document.createElement('div'); div.className='section'; div.style.fontSize='11px'; div.style.lineHeight='1.2'; div.style.boxShadow='0 1px 4px rgba(0,0,0,0.08)'; const d=NOTE[id]; div.innerHTML=`<div style="font-weight:600;color:#1f2937">${d.title}</div><ul style="margin:4px 0 0 16px;color:#374151">${d.bullets.map(b=>`<li>${b}</li>`).join('')}</ul>`; tooltipEl.appendChild(div); svgEl.appendChild(tooltipEl); }

  // æ¸²æŸ“
  function renderLinks(){ linkElems.forEach(({e,path})=>{ path.setAttribute('stroke-width', String(strokeWidthFor(e.w))); path.setAttribute('opacity', String(stageOpacity(e.stage,e.w))); }); }
  function renderNodes(){ const chipWidth= state.labelsOn?112:64; const chipHalf=chipWidth/2; nodeElems.forEach(({fo,rect})=>{ rect.setAttribute('x', String(-chipHalf)); rect.setAttribute('width', String(chipWidth)); fo.setAttribute('x', String(-chipHalf+2)); fo.setAttribute('width', String(chipWidth-4)); const span=fo.querySelector('span:nth-child(2)'); if(span){ span.style.display = state.labelsOn? 'inline' : 'none'; } }); }
  function renderTimeline(){ const arr=['åˆ†å­','ç»†èƒ','ç»„ç»‡','å™¨å®˜']; timelineCircles.forEach((c,i)=>{ c.setAttribute('fill', (state.step>=i)?'#111827':'#fff'); c.nextSibling.textContent=arr[i]; }); }
  function renderOrgan(){ organGroup.style.display = state.organFocus ? 'block' : 'none'; if(state.organFocus) buildOrganCards(); }
  function renderAll(){ renderLinks(); renderNodes(); renderToolTip(); renderTimeline(); renderOrgan(); }

  // åˆå§‹åŒ–
  (function init(){
    const bg = make('rect',{x:0,y:0,width:W,height:H,fill:'#fff'}); svgEl.appendChild(bg);
    // åˆ—ã€çº¿ã€ç‚¹
    ;['åˆ†å­','ç»†èƒ','ç»„ç»‡','å™¨å®˜'].forEach(()=>{}); // ä¿ç•™ä»¥ä¾¿ä»¥åæ‰©å±•
    renderAll(); // å…ˆæ¸²æŸ“ä¸€æ¬¡ï¼Œéšåæ„å»º
  })();

  // å…ˆæ„å»ºå†åˆ·æ–°ï¼ˆä¿è¯æ¬¡åºï¼‰
  ;(function build(){
    // éœ€è¦å…ˆæŠŠåˆ—ã€è¿çº¿ã€èŠ‚ç‚¹åŠ å…¥ï¼Œå†ç»Ÿä¸€åˆ·æ–°
    // åˆ—
    ;['åˆ†å­','ç»†èƒ','ç»„ç»‡','å™¨å®˜'].forEach((c,i)=>{
      const g=make('g'); const rect=make('rect',{x:x(i)-110,y:30,width:220,height:520-80,rx:18,fill:'#fff'});
      const text=make('text',{x:x(i),y:54,'text-anchor':'middle',fill:'#6b7280','font-size':14}); text.style.fontWeight=600; text.textContent=c;
      g.append(rect,text); svgEl.appendChild(g);
    });
    // è¿çº¿
    const tmpLinks=[]; links.forEach(e=>{ const a=nodePos[e.s], b=nodePos[e.t]; const p=make('path',{d:pathD(a,b),fill:'none','stroke-linejoin':'round','stroke-linecap':'round',stroke:'#111827'}); svgEl.appendChild(p); tmpLinks.push({e,path:p}); });
    linkElems.push(...tmpLinks);
    // èŠ‚ç‚¹
    nodes.forEach(n=>{
      const g=make('g',{transform:`translate(${nodePos[n.id].x}, ${nodePos[n.id].y})`});
      const rect=make('rect',{x:-56,y:-20,width:112,height:40,rx:20,fill:toneFill(n.col),stroke:'#d1d5db'});
      const fo=make('foreignObject',{x:-54,y:-18,width:108,height:36});
      const div=document.createElement('div'); Object.assign(div.style,{width:'100%',height:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:'4px',borderRadius:'18px',border:'1px solid #e5e7eb',background:'transparent'});
      const emoji=document.createElement('span'); emoji.textContent=n.emoji; Object.assign(emoji.style,{fontSize:'15px',lineHeight:'1'});
      const label=document.createElement('span'); label.textContent=n.label; Object.assign(label.style,{fontSize:'11px',lineHeight:'1',color:'#1f2937'});
      div.append(emoji,label); fo.appendChild(div); g.append(rect,fo); svgEl.appendChild(g);
      g.addEventListener('mouseenter',()=>{state.hover=n.id; renderToolTip();}); g.addEventListener('mouseleave',()=>{ if(state.hover===n.id){state.hover=null; renderToolTip();}});
      nodeElems.push({n,g,rect,fo,label});
    });
    renderAll();
  })();

  // äº¤äº’
  let timer=null; function setAuto(v){ state.auto=v; if(timer){clearInterval(timer); timer=null;} if(state.auto){ timer=setInterval(()=>{ state.step = state.step>=3?0:state.step+1; syncStepButtons(); renderLinks(); renderTimeline(); }, 1400); } document.getElementById('autoBtn').classList.toggle('active', state.auto); document.getElementById('autoBtn').textContent = state.auto ? 'æš‚åœ' : 'çº¿æ€§æ’­æ”¾'; }

  function syncStepButtons(){ document.querySelectorAll('#stepGroup .btn').forEach(b=>{ const s=Number(b.dataset.step); b.classList.toggle('active', s===state.step); }); }

  document.getElementById('autoBtn').addEventListener('click',()=>setAuto(!state.auto));
  document.getElementById('labelBtn').addEventListener('click',()=>{ state.labelsOn=!state.labelsOn; document.getElementById('labelBtn').classList.toggle('active', state.labelsOn); document.getElementById('labelBtn').textContent = state.labelsOn ? 'å›¾æ ‡+çŸ­è¯' : 'ä»…å›¾æ ‡'; renderNodes(); });
  document.getElementById('primaryBtn').addEventListener('click',(e)=>{ state.primaryOnly=!state.primaryOnly; e.currentTarget.classList.toggle('active', state.primaryOnly); renderLinks(); });
  document.getElementById('organBtn').addEventListener('click',(e)=>{ state.organFocus=!state.organFocus; e.currentTarget.classList.toggle('active', state.organFocus); if(state.organFocus){ state.step=3; syncStepButtons(); } renderOrgan(); renderTimeline(); });
  document.getElementById('notesBtn').addEventListener('click',(e)=>{ state.showNotes=!state.showNotes; e.currentTarget.classList.toggle('active', state.showNotes); e.currentTarget.textContent = state.showNotes ? 'éšè—è¯´æ˜' : 'æ˜¾ç¤ºè¯´æ˜'; notesBox.style.display = state.showNotes? 'block':'none'; });
  document.querySelectorAll('[data-contrast]').forEach(b=>{ b.addEventListener('click',()=>{ state.contrast=Number(b.dataset.contrast); document.querySelectorAll('[data-contrast]').forEach(bb=>bb.classList.toggle('active', bb===b)); renderLinks(); }); });
  document.querySelectorAll('#stepGroup .btn').forEach(b=>{ b.addEventListener('click',()=>{ state.step=Number(b.dataset.step); syncStepButtons(); renderLinks(); renderTimeline(); }); });
})();
</script>
</body>
</html>
